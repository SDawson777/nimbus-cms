name: Enterprise Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  enterprise-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure pnpm on PATH
        run: |
          npm install -g pnpm@9
          pnpm --version

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      # pnpm is already ensured earlier so caching/setup can rely on it

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Run types (server)
        run: pnpm run lint:types

      - name: Run client env audit
        run: pnpm audit:client-envs

      - name: Generate license report
        run: pnpm licenses:generate
      - name: Install Playwright browsers
        run: pnpm -w dlx playwright install --with-deps
      - name: Build server and admin
        run: |
          pnpm -C server build
          pnpm -C apps/admin build

      - name: Start server and admin preview (background)
        run: |
          # Seed test admin via env vars and write to server/config/admins.json for deterministic E2E
          # If you want to override these defaults in GitHub Actions, add an
          # `env:` mapping in this step from repo secrets/variables.
          export SERVER_JWT_SECRET="test-jwt-secret-xxxxxxxxxxxxxxxxxxxxxxxx"
          # Provide JWT_SECRET expected by server config (some scripts expect JWT_SECRET)
          export JWT_SECRET="$SERVER_JWT_SECRET"
          export E2E_ADMIN_EMAIL="e2e-admin@example.com"
          export E2E_ADMIN_PASSWORD="e2e-password"
          export E2E_ADMIN_SECONDARY_EMAIL="e2e-editor@example.com"
          export E2E_ADMIN_SECONDARY_PASSWORD="e2e-editor-pass"
          export E2E_ADMIN_SECONDARY_ROLE="EDITOR"
          export DATABASE_URL="file:./dev.db"
          export CORS_ORIGIN_ADMIN="http://localhost:5174"
          export NODE_ENV=development

          # Write seeded admin into server/config/admins.json so the server uses file-backed admin auth
          pnpm -C server run seed:e2e

          # Validate the seeded admin exists in the file
          node -e "const fs=require('fs');const p='server/config/admins.json';const e=process.env.E2E_ADMIN_EMAIL||'e2e-admin@example.com';if(!fs.existsSync(p)){console.error('admins.json missing');process.exit(2);}const j=JSON.parse(fs.readFileSync(p,'utf8'));if(!Array.isArray(j.admins)||!j.admins.find(a=>a.email===e)){console.error('Seeded admin not found in '+p);console.error(JSON.stringify(j,null,2));process.exit(2);}console.log('Seeded admin validated');"

          # Start server
          nohup node server/dist/index.js > server.log 2>&1 &
          echo $! > server.pid

          # Start admin preview
          pushd apps/admin
          nohup pnpm preview -- --port 5174 > admin.log 2>&1 &
          echo $! > ../../admin.pid
          popd

      - name: Wait for services
        run: |
          # Wait up to 2 minutes for both services to become available. If they
          # don't respond in time, dump the server and admin logs to help
          # diagnose the failure and fail the job.
          pnpm -w dlx wait-on --timeout 120000 http://localhost:8080/healthz http://localhost:5174 || (
            echo "\nERROR: Services did not become ready within timeout. Dumping logs...\n";
            echo "---- server.log (last 200 lines) ----";
            if [ -f server.log ]; then tail -n 200 server.log; else echo "(no server.log)"; fi;
            echo "---- admin dist index.html (head) ----";
            if [ -f apps/admin/dist/index.html ]; then sed -n '1,200p' apps/admin/dist/index.html; else echo "(no apps/admin/dist/index.html)"; fi;
            exit 1
          )

      - name: Run admin e2e tests (blocking)
        working-directory: apps/admin
        run: pnpm test:e2e

      - name: Run server unit tests
        working-directory: server
        run: pnpm test

      - name: Tear down background services
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi
          if [ -f admin.pid ]; then kill "$(cat admin.pid)" || true; fi
          sleep 1

      - name: Restore admins.json backup (if present)
        if: always()
        run: |
          CFG="server/config/admins.json"
          BACKUP=$(ls ${CFG}.bak.* 2>/dev/null | tail -n 1 || true)
          if [ -n "$BACKUP" ]; then
            echo "Restoring $CFG from $BACKUP"
            mv "$BACKUP" "$CFG"
          else
            echo "No admins.json backup found; leaving $CFG as-is"
          fi

      - name: Upload server & admin logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-admin-logs
          path: |
            server.log
            admin.log

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            apps/admin/playwright-report
            test-results/**
