#!/usr/bin/env node
const { spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

const outPath = path.join(__dirname, '..', 'docs', 'licenses.md');

console.log('Generating license report (this may take a few seconds)...');
const cmd = spawn('npx', ['license-checker', '--json', '--production'], { stdio: ['ignore', 'pipe', 'inherit'] });
let out = '';
cmd.stdout.on('data', (d) => (out += d.toString()));
cmd.on('close', (code) => {
  if (code !== 0) {
    console.error('license-checker failed with code', code);
    process.exit(code || 1);
  }
  try {
    const parsed = JSON.parse(out);
    const lines = ['# Dependency Licenses', '', '> Generated by `scripts/generate-license-report.js`', ''];
    for (const [pkg, info] of Object.entries(parsed)) {
      const i = info || {};
      lines.push(`- **${pkg}**: ${i.licenses || 'UNKNOWN'}${i.repository ? ` â€” ${i.repository}` : ''}`);
    }
    fs.mkdirSync(path.dirname(outPath), { recursive: true });
    fs.writeFileSync(outPath, lines.join('\n'));
    console.log('Wrote', outPath);
  } catch (e) {
    console.error('Failed to parse license-checker output', e);
    process.exit(1);
  }
});
