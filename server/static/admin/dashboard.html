<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard — Nimbus Cannabis OS CMS</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .dash {
        max-width: 980px;
        margin: 28px auto;
        padding: 18px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
      }
      .dash a {
        display: inline-block;
        margin-right: 10px;
      }
      .cards {
        min-height: 60px;
        margin-top: 12px;
      }
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }
      .card-grid article {
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.15);
      }
      .card-grid h4 {
        margin-top: 0;
      }
      .card-grid ol {
        margin: 0;
        padding-left: 20px;
      }
    </style>
  </head>
  <body>
    <a class="skip-link" href="#dashboard">Skip to dashboard</a>
    <div class="container">
      <div class="site-top">
        <div class="brand">
          <img class="logo" src="/nimbus-logo.svg" alt="Nimbus Cannabis OS CMS logo" />
          <strong>Nimbus Cannabis OS CMS</strong>
        </div>
        <div class="nav">
          <a class="card" href="/">Home</a>
          <a class="card" href="/admin/settings">Settings</a>
          <a class="card" href="/admin/logout">Sign out</a>
        </div>
      </div>
      <div id="dashboard" class="dash">
        <h2>Admin Dashboard</h2>
        <p>Welcome. Use the quick links below to inspect and manage content.</p>
        <p>
          <a class="card" href="/api/admin/products">Products (JSON)</a>
          <a class="card" href="/content/faq">FAQs</a>
          <a class="card" href="/content/articles">Articles</a>
          <a class="card" href="/status">Status</a>
        </p>

        <section aria-live="polite" style="margin-top: 24px">
          <header style="display: flex; justify-content: space-between; align-items: center">
            <h3 style="margin: 0">Analytics overview</h3>
            <small id="analytics-cache-status" style="opacity: 0.7"></small>
          </header>
          <div id="analytics-overview" class="cards" role="status">
            <p>Loading analytics…</p>
          </div>
        </section>
      </div>
    </div>
    <div
      class="a11y-widget"
      aria-hidden="false"
      style="position: fixed; right: 12px; bottom: 12px; z-index: 999"
    >
      <button id="a11y-contrast" title="Toggle high contrast" aria-pressed="false">Contrast</button>
      <button id="a11y-large" title="Toggle large text" aria-pressed="false">Large text</button>
      <button id="a11y-dyslexic" title="Toggle dyslexia-friendly font" aria-pressed="false">
        Dyslexic
      </button>
    </div>
    <script>
      const overviewEl = document.getElementById('analytics-overview')
      const cacheStatusEl = document.getElementById('analytics-cache-status')

      function metricList(items, labelFormatter) {
        if (!items || !items.length) return '<p>No data available.</p>'
        return `
          <ol>
            ${items
              .map((item) => `<li>${labelFormatter(item)}</li>`)
              .join('')}
          </ol>
        `
      }

      function productDelta(series) {
        if (!series || !series.length) return 0
        const sorted = [...series].sort((a, b) => a.date.localeCompare(b.date))
        if (sorted.length < 2) return sorted[sorted.length - 1]?.views || 0
        const latest = sorted[sorted.length - 1]
        const prev = sorted[sorted.length - 2]
        return (latest.views || 0) - (prev.views || 0)
      }

      async function loadOverview() {
        try {
          const res = await fetch('/api/admin/analytics/overview?limit=5', {
            credentials: 'include',
          })
          if (!res.ok) throw new Error('Request failed')
          cacheStatusEl.textContent = res.headers.get('X-Analytics-Overview-Cache') || ''
          const json = await res.json()
          const productSeriesBySlug = {}
          ;(json.productSeries || []).forEach((entry) => {
            productSeriesBySlug[entry.slug] = entry.series || []
          })
          const topArticles = json.topArticles || []
          const topFaqs = json.topFaqs || []
          const topProducts = json.topProducts || []
          const productDemand = json.productDemand || []
          const storeEngagement = json.storeEngagement || []

          overviewEl.innerHTML = `
            <div class="card-grid">
              <article>
                <h4>Top articles</h4>
                ${metricList(topArticles, (item) => `${item.contentSlug} — ${item.views} views`)}
              </article>
              <article>
                <h4>Top FAQs</h4>
                ${metricList(topFaqs, (item) => `${item.contentSlug} — ${item.views} views`)}
              </article>
              <article>
                <h4>Top products</h4>
                ${metricList(topProducts, (item) => `${item.contentSlug} — ${item.clickThroughs} clicks`)}
              </article>
            </div>
            <div class="card-grid" style="margin-top: 16px">
              <article>
                <h4>Product demand delta</h4>
                ${metricList(
                  productDemand,
                  (item) => {
                    const delta = productDelta(productSeriesBySlug[item.slug] || [])
                    const trend = delta > 0 ? '▲' : delta < 0 ? '▼' : '•'
                    return `${item.slug} — ${item.status} (${trend} ${delta} views day-over-day)`
                  },
                )}
              </article>
              <article>
                <h4>Store engagement</h4>
                ${metricList(storeEngagement, (item) => `${item.storeSlug}: ${item.views} views`)}
              </article>
            </div>
          `
        } catch (err) {
          overviewEl.innerHTML = '<p style="color: #f55">Failed to load analytics data.</p>'
          cacheStatusEl.textContent = ''
        }
      }

      loadOverview()
    </script>
    <script src="/a11y.js"></script>
  </body>
</html>
